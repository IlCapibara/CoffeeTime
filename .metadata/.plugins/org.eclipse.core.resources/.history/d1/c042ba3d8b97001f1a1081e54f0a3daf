package com.gc.coffeetime.service;

import java.io.File;
import java.io.IOException;
import java.nio.file.FileVisitOption;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;

import com.gc.coffeetime.model.ProjectVersions;
import com.github.lalyos.jfiglet.FigletFont;

public class RepositoryServiceImpl implements RepositoryService {

    // Constructor
    public RepositoryServiceImpl() {
        printBanner();
    }

    // Banner
    @Override
    public void printBanner() {
        try {
            String asciiArt = FigletFont.convertOneLine("CoffeeTime");
            System.out.println(asciiArt);
        } catch (Exception e) {
            e.printStackTrace();
        }

        System.out.println("==========================================================");
        System.out.println("This program scans all pom.xml files in the selected      ");
        System.out.println("folder, finds the latest local versions for dependencies, ");
        System.out.println("and updates the pom.xml files accordingly.                ");
        System.out.println("==========================================================\n");
    }

    @Override
    public List<File> findAllPomFiles(String startDir) {
        List<File> pomFiles = new ArrayList<>();
        try (Stream<Path> paths = Files.walk(Paths.get(startDir), FileVisitOption.FOLLOW_LINKS)) {
            pomFiles = paths
                    .filter(Files::isRegularFile)
                    // Excluding target directories
                    .filter(path -> !path.toString().contains(File.separator + "target" + File.separator))
                    .filter(path -> path.getFileName().toString().equals("pom.xml"))
                    .map(Path::toFile)
                    .collect(Collectors.toList());
        } catch (IOException e) {
            e.printStackTrace();
        }
        return pomFiles;
    }

    public List<ProjectVersions> getLocalVersions(List<File> pomFiles) {
        List<ProjectVersions> pomListWithVersion = new ArrayList<>();
        for (File pomFile : pomFiles) {
            ProjectVersions info = readPomFile(pomFile);
            if (info != null) {
                pomListWithVersion.add(info);
            }
        }
        return pomListWithVersion;
    }

    @Override
    public ProjectVersions readPomFile(File pomFile) {
        try {
            Document doc = Jsoup.parse(pomFile, "UTF-8", "", org.jsoup.parser.Parser.xmlParser());
            String groupId = doc.selectFirst("groupId").text();
            String artifactId = doc.selectFirst("artifactId").text();
            String version = doc.selectFirst("version").text();

            return new ProjectVersions(groupId, artifactId, version);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    public void updatePomFile(File pomFile, List<ProjectVersions> latestVersions) {
        try {
            Document doc = Jsoup.parse(pomFile, "UTF-8", "", org.jsoup.parser.Parser.xmlParser());

            for (Element dependency : doc.select("dependency")) {
                String groupId = dependency.selectFirst("groupId").text();
                String artifactId = dependency.selectFirst("artifactId").text();
                Element versionElement = dependency.selectFirst("version");

                if (versionElement != null) {
                    String currentVersion = versionElement.text();
                    String latestVersion = getLatestVersion(groupId, artifactId, latestVersions);

                    if (latestVersion != null && !latestVersion.equals(currentVersion)) {
                        if (currentVersion.startsWith("${") && currentVersion.endsWith("}")) {
                            String propertyName = currentVersion.substring(2, currentVersion.length() - 1);
                            updatePropertyVersion(doc, propertyName, latestVersion);
                        } else {
                            versionElement.text(latestVersion);
                            System.out.println("Updated " + groupId + ":" + artifactId + " from version " + currentVersion + " to " + latestVersion);
                        }
                    }
                }
            }

            saveDocumentToFile(doc, pomFile);

        } catch (Exception e) {
            System.err.println("Error processing file: " + pomFile.getAbsolutePath());
            e.printStackTrace();
        }
    }

    private String getLatestVersion(String groupId, String artifactId, List<ProjectVersions> latestVersions) {
        for (ProjectVersions version : latestVersions) {
            if (version.getGroupId().equals(groupId) && version.getArtifactId().equals(artifactId)) {
                return version.getVersion();
            }
        }
        return null;
    }

    private void saveDocumentToFile(Document doc, File file) {
        try {
            Files.write(file.toPath(), doc.outerHtml().getBytes(StandardCharsets.UTF_8));
            System.out.println("File saved successfully: " + file.getAbsolutePath());
        } catch (IOException e) {
            System.err.println("Error saving file: " + file.getAbsolutePath());
            e.printStackTrace();
        }
    }

    public void updateAllPomFiles(String startDir) {
        List<File> pomFiles = findAllPomFiles(startDir);
        List<ProjectVersions> latestVersions = getLocalVersions(pomFiles);

        for (File pomFile : pomFiles) {
            System.out.println("Updating " + pomFile.getAbsolutePath());
            updatePomFile(pomFile, latestVersions);
        }

        System.out.println("All pom.xml files have been updated.");
    }

    private void updatePropertyVersion(Document doc, String propertyName, String newVersion) {
        Element propertiesElement = doc.selectFirst("properties");

        if (propertiesElement != null) {
            Element property = propertiesElement.selectFirst(propertyName);
            if (property != null) {
                System.out.println("Updating property " + propertyName + " to version " + newVersion);
                property.text(newVersion);
            } else {
                System.out.println("Property " + propertyName + " not found in <properties>.");
            }
        }
    }

	@Override
	public ProjectVersions readPomFile(File pomFile) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public void updatePomFile(File pomFile, List<ProjectVersions> latestVersions) {
		// TODO Auto-generated method stub
		
	}
}
